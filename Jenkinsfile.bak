pipeline {
  agent any

  stages {

    stage('Checkout') {
      steps {
        cleanWs()
        git branch: 'main', credentialsId: 'github-creds', url: 'https://github.com/rvorbita/mini_shop.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -t mini_shop:latest .'
      }
    }

    stage('Test Container') {
      steps {
        sh '''
          docker run -d -p 5001:5001 --name test_app mini_shop:latest
          sleep 5
          curl -f http://localhost:5001 || exit 1
          docker rm -f test_app
        '''
      }
    }

    stage('Deploy to k3s') {
      steps {
        withCredentials([file(credentialsId: 'k3s-config', variable: 'KUBECONFIG')]) {
          sh '''
            export KUBECONFIG=$KUBECONFIG
            kubectl apply -f k8s/
          '''
        }
      }
    }
  }
}
